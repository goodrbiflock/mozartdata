CREATE OR REPLACE TABLE staging.netsuite_customers
	COPY GRANTS AS
SELECT cust.id                                                                 AS customer_id_ns,
	   cust.altname                                                            AS customer_name,
	   cust.entityid                                                           AS customer_number,
	   cust.parent                                                             AS parent_id_ns,
	   parent.ENTITYID                                                         AS parent_customer_number,
	   parent.altname                                                          AS parent_name,
	   cust.isperson                                                           AS is_person_flag,
	   CASE WHEN cust.parent IS NULL THEN TRUE ELSE FALSE END                  AS is_parent_flag,
	   cust.email,
	   NULLIF(LOWER(cust.email), '')                                           AS normalized_email,
	   cust.PHONE,
	   NULLIF(REGEXP_REPLACE(cust.phone, '^1|\\+1\\s?|\\(|\\)|-|\\s', ''), '') AS normalized_phone_number,
	   cust.firstname,
	   cust.lastname,
	   cust.firstorderdate,
	   cust.firstsaledate,
	   cust.LASTORDERDATE,
	   cust.lastsaledate,
	   cust.entitytitle,
	   cust.category,
	   cust.companyname                                                        AS company_name,
	   cust.CUSTENTITY_BOOMI_EXTERNALID,
	   cust.CUSTENTITY_BOOMI_SOURCE,
	   cust.DATECREATED,
	   cust.DEFAULTBILLINGADDRESS,
	   cust.DEFAULTSHIPPINGADDRESS,
	   cust.custentityam_primary_sport                                         AS primary_sport,
	   cust.custentityam_secondary_sport                                       AS secondary_sport,
	   cust.custentityam_tertiary_sport                                        AS tertiary_sport,
	   cust.custentityam_tier                                                  AS tier,
	   cust.custentityam_doors                                                 AS doors,
	   cust.custentityam_buyer_name                                            AS buyer_name,
	   cust.custentityam_buyer_email                                           AS buyer_email,
	   cust.custentityam_pop                                                   AS pop,
	   cust.custentityam_logistics                                             AS logistics,
	   cust.custentityam_city_1                                                AS city_1,
	   cust.custentityam_city_2                                                AS city_2,
	   cust.custentityam_city_3                                                AS city_3,
	   cust.custentityam_state_1                                               AS state_1,
	   cust.custentityam_state_2                                               AS state_2,
	   cust.custentityam_state_3                                               AS state_3,
	   cust.duplicate
FROM netsuite.customer cust
		 LEFT JOIN netsuite.customer parent
				   ON cust.parent = parent.id
WHERE cust._FIVETRAN_DELETED = FALSE
  AND (parent._FIVETRAN_DELETED = FALSE OR parent._FIVETRAN_DELETED IS NULL)

